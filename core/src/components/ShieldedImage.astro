---
// Copyright (c) 2025 Michele Tavella <meeghele@proton.me>
// Licensed under the MIT License. See LICENSE file for details.

import { Image } from "astro:assets";

// Extract all Image props except src, which we'll handle specially
const { src, alt = "", ...imageProps } = Astro.props;

// Normalise the source we expose via data attributes
const resolvedSrc = typeof src === "string" ? src : src.src;

// Generate a placeholder data URL to prevent broken image displays
const placeholderDataUrl = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiBmaWxsPSIjZjNmNGY2Ii8+CjxwYXRoIGQ9Ik0xMiAxNmMtMi4yMSAwLTQtMS43OS00LTRzMS43OS00IDQtNCA0IDEuNzkgNCA0LTEuNzkgNC00IDR6bTAtNmMtMS4xIDAtMiAuOS0yIDJzLjkgMiAyIDIgMi0uOSAyLTItLjktMi0yLTJ6IiBmaWxsPSIjOWNhM2FmIi8+Cjwvc3ZnPgo=";
---

<!--
  ShieldedImage component that protects images by using data-src initially.
  The BaseLayout script will swap data-src to src after gate validation.
-->
<Image
  src={placeholderDataUrl}
  data-src={resolvedSrc}
  data-guarded="true"
  alt={alt}
  {...imageProps}
/>

<style>
  /* Style for guarded images while loading */
  img[data-guarded="true"] {
    opacity: 0.8;
    transition: opacity 0.3s ease;
  }

  /* Style for loaded guarded images */
  img[data-guarded="true"]:not([data-src]) {
    opacity: 1;
  }

  /* Prevent right-click context menu on guarded images */
  img[data-guarded="true"] {
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    -webkit-touch-callout: none;
    -webkit-user-drag: none;
    -khtml-user-drag: none;
    -moz-user-drag: none;
    -o-user-drag: none;
    pointer-events: auto;
  }

  /* Disable image drag */
  img[data-guarded="true"] {
    -webkit-user-drag: none;
    -khtml-user-drag: none;
    -moz-user-drag: none;
    -o-user-drag: none;
    user-drag: none;
  }
</style>

<script>
  // Additional client-side protection for guarded images
  document.addEventListener('DOMContentLoaded', () => {
    const guardedImages = document.querySelectorAll('img[data-guarded="true"]');

    guardedImages.forEach(img => {
      // Disable right-click context menu
      img.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        return false;
      });

      // Disable drag and drop
      img.addEventListener('dragstart', (e) => {
        e.preventDefault();
        return false;
      });

      // Monitor for developer tools tampering
      img.addEventListener('load', () => {
        // If the image loaded but still has data-src, someone might be tampering
        if (img.hasAttribute('data-src') && img.src !== img.dataset.src) {
          // This is expected during initial load with placeholder
          return;
        }
      });

      // Add honeypot-like behavior - detect bot attempts to access src directly
      Object.defineProperty(img, '_originalSrc', {
        value: img.dataset.src,
        writable: false,
        enumerable: false
      });
    });
  });
</script>
